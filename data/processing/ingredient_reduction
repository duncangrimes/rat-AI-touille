import os
import pandas as pd
import json

source_folder = 'data/processing/stage_1'
target_folder = 'data/processing/stage_1.5'



with open('data/processing/stage_1/ingredient_df.json', 'r') as file:
    data = json.load(file)
    recipes = pd.DataFrame(data)

    # Find recipes to drop
    recipes_to_drop = recipes.loc[recipes['i_33'].notnull()]
    recipes_to_drop = list(recipes_to_drop['id'])
    print ('Dropping recipes:')
    print(recipes_to_drop)

    # Drop rows and columns
    recipes = recipes.loc[recipes['i_33'].isnull()]
    columns_to_drop = [f'i_{i}' for i in range(33, 77)]
    recipes.drop(columns=columns_to_drop, inplace=True)

# Write desired recipes to a new file
target_path = os.path.join(target_folder, 'ingredient_df.json')
with open(target_path, 'w') as file:
    file.write(recipes.to_json(orient='records'))

# Ensure the target folder exists, create if not
os.makedirs(target_folder, exist_ok=True)

# Loop through each file in the source folder
for filename in os.listdir(source_folder):
    source_path = os.path.join(source_folder, filename)
    
    # Check if it's a file, not a directory
    if (os.path.isfile(source_path) and filename != 'ingredient_df.json'):
        # Open and read the file
        with open(source_path, 'r') as file:
            data = json.load(file)
            recipes = pd.DataFrame(data)

        # drop all recipes that have 33 or more ingredients
        recipes = recipes[~recipes['id'].isin(recipes_to_drop)]
        
        target_path = os.path.join(target_folder, filename)

        # Write desired recipes to a new file
        with open(target_path, 'w') as file:
            file.write(recipes.to_json(orient='records'))